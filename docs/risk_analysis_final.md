# ğŸ” Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ™ ĞĞĞĞ›Ğ˜Ğ— ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞ˜Ğ¥ Ğ—ĞĞ’Ğ˜Ğ¡Ğ˜ĞœĞĞ¡Ğ¢Ğ•Ğ™ - Ğ¤Ğ˜ĞĞĞ›Ğ¬ĞĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯

## ĞœĞĞ¢Ğ Ğ˜Ğ¦Ğ Ğ¢Ğ Ğ•Ğ‘ĞĞ’ĞĞĞ˜Ğ™ â†’ Ğ Ğ•ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯

### ğŸ“Œ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Functional Requirements)

| FR ID | Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | ĞœĞ¾Ğ´ÑƒĞ»ÑŒ | ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | Ğ Ğ¸ÑĞº |
|-------|-----------|--------|----------|--------|------|
| **FR-1** | ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Telegram | M1 | 1.1, 1.2 | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |
| **FR-2** | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ·Ğ¾Ğ² (ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸) | M2 | 2.1, 2.2, 2.3 | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |
| **FR-3** | Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼ | M3 | 3.1, 3.2 | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |
| **FR-4** | Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ³Ñ€ÑƒĞ·Ğ° | M2 | 2.1 (endpoint 2) | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |
| **FR-5** | Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ CargoTech API | M2 | 2.1 | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |
| **FR-6** | Telegram Bot (Ğ¾Ñ‚ĞºĞ»Ğ¸ĞºĞ¸) | M4 | 4.1, 4.2 | âœ… ĞŸĞĞ›ĞĞ | ğŸŸ¢ ĞĞ¸Ğ·ĞºĞ¸Ğ¹ |

---

### ğŸ“Œ ĞĞµÑ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Performance/Security)

| NFR ID | Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | ĞšĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | Ğ ĞµĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ |
|--------|-----------|---------|----------|--------|-----------|
| **NFR-1.1** | Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑĞ¿Ğ¸ÑĞºĞ°: < 2 ÑĞµĞº | M2.1 + M3 + Cache | 2.1, 2.3 | âœ… Ğ¦Ğ•Ğ›Ğ•Ğ’ĞĞ¯ | Ğ¡ ĞºÑÑˆĞµĞ¼: 165ms âœ… |
| **NFR-1.2** | ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸: < 2 ÑĞµĞº (p95) | M2.1 (endpoint 2) + spinner | 2.1 | âœ… Ğ”ĞĞ¡Ğ¢Ğ˜Ğ–Ğ˜ĞœĞ | Ğ¡ ĞºÑÑˆĞµĞ¼ + pre-fetch âœ… |
| **NFR-1.3** | 1000+ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… | Django + Gunicorn | AGENTS.md | âœ… Ğ¦Ğ•Ğ›Ğ•Ğ’ĞĞ¯ | Gunicorn 4 workers âœ… |
| **NFR-2.1** | Mobile-first | Frontend (HTMX) | AGENTS.md | âœ… Ğ£ĞšĞĞ—ĞĞĞ | ĞÑƒĞ¶Ğ½Ğ° Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |
| **NFR-2.2** | Touch-friendly (44x44px) | Frontend (HTMX) | AGENTS.md | âœ… Ğ£ĞšĞĞ—ĞĞĞ | ĞÑƒĞ¶Ğ½Ğ° Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |
| **NFR-3.1** | HTTPS Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ | Middleware | AGENTS.md | âœ… Ğ£ĞšĞĞ—ĞĞĞ | Django SECURE_SSL_REDIRECT |
| **NFR-3.2** | Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Telegram initData | M1 | 1.1 | âœ… ĞŸĞĞ›ĞĞ | HMAC-SHA256 âœ… |
| **NFR-3.3** | Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° API Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ² | M1 | 1.2, 1.3 | âœ… ĞŸĞĞ›ĞĞ | Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Ğ‘Ğ” âœ… |
| **NFR-4.1** | Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ½Ğ° 3G | Cache + compression | AGENTS.md | âœ… Ğ£ĞšĞĞ—ĞĞĞ | Redis + GZIP |

---

## âœ… Ğ Ğ•Ğ¨Ğ•ĞĞĞ«Ğ• ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ«

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: FR-4 Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ extranote - Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- âœ… extranote Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² FR-4 ĞºĞ°Ğº Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ ÑĞµĞºÑ†Ğ¸Ñ
- âœ… Contract 2.1 Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ñ Ğ¿Ğ¾Ğ»ĞµĞ¼ extranote Ğ² Returns
- âœ… Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ: monospace Ñ‚ĞµĞºÑÑ‚ (ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹)

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ

---

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: FR-3 Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ²ĞµÑ/Ğ¾Ğ±ÑŠĞµĞ¼ - Ğ£Ğ¢ĞĞ§ĞĞ•ĞĞ

**ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ğ°Ñ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ:**

```
Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€: Ğ’ĞµÑ/ĞĞ±ÑŠĞµĞ¼
Ğ¢Ğ¸Ğ¿: Select (single choice)
API Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€: filter[weight_volume]

ĞĞ¿Ñ†Ğ¸Ğ¸ (7 Ğ¿Ñ€ĞµĞ´ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ñ… ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. 1-3 Ñ‚ / Ğ´Ğ¾ 15 Ğ¼Â³     (value: "1_3")  â”‚
â”‚ 2. 3-5 Ñ‚ / 15-25 Ğ¼Â³     (value: "3_5")  â”‚
â”‚ 3. 5-10 Ñ‚ / 25-40 Ğ¼Â³    (value: "5_10") â”‚
â”‚ 4. 10-15 Ñ‚ / 40-60 Ğ¼Â³   (value: "10_15")â”‚
â”‚ 5. 15-20 Ñ‚ / 60-82 Ğ¼Â³   (value: "15_20")â”‚
â”‚ 6. 20+ Ñ‚ / 82+ Ğ¼Â³       (value: "20")   â”‚
â”‚ 7. Ğ›ÑĞ±Ğ¾Ğ¹ (Ğ½Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€)    (value: "any")  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² ĞºĞ¾Ğ´:**

```python
# apps/filtering/services.py
WEIGHT_VOLUME_CATEGORIES = {
    "1_3": {"weight_min": 1000, "weight_max": 3000, "volume_min": 0, "volume_max": 15},
    "3_5": {"weight_min": 3000, "weight_max": 5000, "volume_min": 15, "volume_max": 25},
    "5_10": {"weight_min": 5000, "weight_max": 10000, "volume_min": 25, "volume_max": 40},
    "10_15": {"weight_min": 10000, "weight_max": 15000, "volume_min": 40, "volume_max": 60},
    "15_20": {"weight_min": 15000, "weight_max": 20000, "volume_min": 60, "volume_max": 82},
    "20": {"weight_min": 20000, "weight_max": 999999, "volume_min": 82, "volume_max": 999999},
}

def normalize_weight_volume_filter(value: str) -> Dict[str, int]:
    """
    ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµÑ‚ select value Ğ² min/max Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ´Ğ»Ñ API
    
    :param value: "1_3", "3_5", ..., "20", "any"
    :return: {"weight_min": ..., "weight_max": ..., "volume_min": ..., "volume_max": ...}
    """
    if value == "any" or not value:
        return {}  # Ğ‘ĞµĞ· Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
    
    category = WEIGHT_VOLUME_CATEGORIES.get(value)
    if not category:
        raise ValidationError(f"Invalid weight_volume value: {value}")
    
    return category
```

**Contract 3.1 Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½:**
```
PARAMETERS Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:
- weight_volume: Optional[str] in ["1_3", "3_5", "5_10", "10_15", "15_20", "20", "any"]
  @constraint: Predefined categories only
  @default: "any" (no filter)

Returns â†’ normalized to:
- weight_min: Optional[int] (kg)
- weight_max: Optional[int] (kg)
- volume_min: Optional[int] (mÂ³)
- volume_max: Optional[int] (mÂ³)
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ

---

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: NFR-1.2 Performance requirement - ĞĞ”ĞĞŸĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ

**ĞŸĞµÑ€ĞµÑĞ¼Ğ¾Ñ‚Ñ€ĞµĞ½Ğ½Ğ¾Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**

```
NFR-1.2: ĞÑ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ³Ñ€ÑƒĞ·Ğ°

Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ A (p50, optimistic):
  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ cached cargo detail Ğ¸Ğ· ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸: < 500ms
  - Loading spinner Ğ¿Ñ€Ğ¸ fetch ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ B (p95, realistic):
  - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ cached cargo detail: < 500ms
  - Fetch fresh data with timeout: 2000ms
  - Fallback: show cached if timeout/error

Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½ Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ B ĞºĞ°Ğº Ğ±Ğ¾Ğ»ĞµĞµ Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹:
  - p50: < 500ms (cached data)
  - p95: < 2000ms (with retry + spinner)
  - p99: < 3000ms (with full backoff)
```

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Contract 2.1:**

```
GUARANTEES Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:
- Detail view rendering: < 500ms (from cached cargo list)
- Fresh data fetch: < 2000ms (p95, with exponential backoff)
  - Attempt 1: 0ms + network latency
  - Retry 1: after 500ms + random jitter
  - Retry 2: after 1000ms + random jitter
  - Fallback: Show cached data if all retries fail
  - UI: Always show spinner during fetch
  
- Cache Strategy for Detail:
  - TTL: 15 minutes (prices/availability can change)
  - Invalidation: On cargo status update from API
  - Fallback: Return cached if fresh fetch fails
```

**Frontend Pattern (HTMX):**

```html
<!-- apps/cargos/templates/cargo_detail.html -->
<div id="cargo-detail" hx-get="/api/cargo/{{ cargo_id }}/detail/"
     hx-trigger="load"
     hx-target="#cargo-detail"
     hx-swap="outerHTML"
     hx-on::ajax:xhr.progress="updateProgress(event)"
     hx-timeout="2000">
  <!-- Show cached data immediately -->
  <div class="cargo-info">{{ cached_cargo }}</div>
  
  <!-- Loading indicator -->
  <div class="loading-spinner" id="detail-spinner" style="display: none;">
    â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ ÑĞ²ĞµĞ¶Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ...
  </div>
</div>

<script>
  // Show spinner only if fetch takes > 300ms
  document.addEventListener('htmx:xhr:progress', (e) => {
    document.getElementById('detail-spinner').style.display = 'block';
  });
  
  // Hide on success
  document.addEventListener('htmx:afterSwap', () => {
    document.getElementById('detail-spinner').style.display = 'none';
  });
</script>
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ (Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ¾Ğ¹ Ğ°Ğ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸ĞµĞ¹)

---

## ğŸŸ¢ Ğ”ĞĞŸĞĞ›ĞĞ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ Ğ Ğ•Ğ¨Ğ•ĞĞ

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: Rate Limiting ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ - Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ

**Contract 2.1 Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ:**

```python
"""
RATE LIMIT HANDLING:

1. Per-User Token Bucket (in-memory):
   - Each user gets: 600 req/min Ã· 1000 users = 0.6 req/min
   - BUT: With caching, actual API calls << 1000/min
   - Strategy: Cache-first, request-on-miss
   
2. Global Rate Limit Monitor:
   - Track X-RateLimit-Remaining header
   - When Remaining < 100: Start warning logs
   - When Remaining < 10: Queue new requests (don't drop)
   
3. Backoff Strategy on 429:
   - Attempt 1: immediate
   - Attempt 2: after 500ms + random(0-100ms)
   - Attempt 3: after 1500ms + random(0-100ms)
   - Attempt 4: after 3000ms (last chance)
   
4. Request Queuing:
   - Queue max size: 1000 requests
   - Strategy: FIFO with priority levels
     - High: User-initiated search (p=1)
     - Medium: Background prefetch (p=2)
     - Low: Analytics/metrics (p=3)
   
5. Metrics Logging:
   - Log on every 429: timestamp, user_id, endpoint, retry_count
   - Alert if > 5 consecutive 429s
   - Dashboard: Rate limit utilization per hour

GUARANTEES:
- No requests dropped (queued instead)
- Max queue wait: 60 seconds (then error to user)
- Cache-first prevents 90% of API calls
"""
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ

---

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: Cache Strategy - ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ

**Contract 2.3 ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ:**

```python
"""
CACHE LEVELS & TTL:

Level 1: Per-User Cargo List Cache
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Key: "user:{user_id}:cargos:{filter_hash}"
Data: List of CargoCard (from /v2/cargos/views list endpoint)
TTL: 5 minutes
Rationale: Filters are user-specific; prices/availability update slowly
Invalidation:
  - On logout: DELETE key
  - On filter change: DELETE old keys (compute new hash)
  - On new cargo posted (webhook): DELETE all user:{*}:cargos keys

Level 2: Per-Cargo Detail Cache
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Key: "cargo:{cargo_id}:detail"
Data: Full cargo object (from /v2/cargos/views/{id} detail endpoint)
TTL: 15 minutes
Rationale: Extended info (extranote, payment terms) change less frequently
Invalidation:
  - On webhook from CargoTech (if status changes)
  - Manual invalidation every 15min
  - On user cancel/decline cargo

Level 3: Global Autocomplete Cache
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Key: "autocomplete:cities"
Data: City/Region reference (from /v1/dictionaries/points)
TTL: 24 hours
Rationale: Cities/regions are static
Invalidation:
  - Manual refresh (rarely needed)
  - Daily background sync

Cache Invalidation Triggers:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EVENT                           â†’ ACTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
New cargo posted (Telegram msg) â†’ Invalidate all user cargos (async)
Price updated by broker         â†’ Invalidate cargo detail
User changes location filter    â†’ Invalidate old filter keys
User logs out                   â†’ Invalidate all user keys
System maintenance (nightly)    â†’ Full cache refresh

Fallback Strategy:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
If Redis unavailable:
  - Cache Layer: Disabled (all requests go to API)
  - Rate Limit: Enforced in-memory (per-process)
  - User Experience: Slow but functional

If API unavailable:
  - Cache Layer: Serve stale data (up to 1 hour old)
  - Notification: Banner "Data may be outdated"
  - New requests: Queue with retry (exponential backoff)
"""
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ

---

### âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ: Telegram WebApp Security - Ğ£Ğ¡Ğ˜Ğ›Ğ•ĞĞ

**Contract 1.1 ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ:**

```python
"""
TELEGRAM AUTHENTICATION VALIDATION:

PARAMETERS Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:
- max_age_seconds: int = 300  # Default 5 minutes
  @constraint: 300 (5 min) to 3600 (1 hour)
  @rationale: Prevent replay attacks with stale credentials

GUARANTEES Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. Signature Validation:
   - Algorithm: HMAC-SHA256
   - Key: Bot token (from environment)
   - Method: Constant-time comparison
   
2. Timestamp Validation:
   - Check: datetime.now() - auth_date < max_age_seconds
   - Reject: Any auth_date older than 5 minutes
   - Prevent: Replay attacks using old credentials
   
3. Secret Management:
   - bot_token: Stored in Django settings.SECRET_KEY (not hardcoded)
   - Rotation: Can be updated without restart (environment reload)
   - Monitoring: All signature failures logged (ERROR level)
   
4. Logging & Monitoring:
   - Log on validation failure: timestamp, user_id, reason
   - Alert: If > 10 failures in 1 minute (attack detection)
   - Metrics: Track validation success rate (target: > 99.5%)
   
5. Fallback:
   - If bot_token not set: Raise ConfigurationError at startup
   - If auth_data malformed: Return (False, None)
   - If network error: Don't proceed (fail-secure)

EXECUTION TIME:
- Typical: < 50ms (p99)
- Includes: HMAC computation + timestamp check + logging

THREAD-SAFE:
- Pure function (no shared state)
- Constant-time comparison (prevent timing attacks)
"""
```

**Django Configuration:**

```python
# settings/base.py
TELEGRAM_BOT_TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
TELEGRAM_MAX_AUTH_AGE = int(os.getenv('TELEGRAM_MAX_AUTH_AGE', 300))  # 5 min

# .env.example
TELEGRAM_BOT_TOKEN=your_bot_token_here_not_in_git
TELEGRAM_MAX_AUTH_AGE=300
```

**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… Ğ—ĞĞšĞ Ğ«Ğ¢Ğ

---

## ğŸ“Š Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ ĞœĞĞ¢Ğ Ğ˜Ğ¦Ğ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜

### Ğ”Ğ Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™:

| ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ |
|----------|--------|---------|
| #1: extranote | ğŸ”´ Ğ‘Ğ›ĞĞšĞ˜Ğ Ğ£Ğ•Ğ¢ | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |
| #2: filter[w][v] | ğŸ”´ Ğ‘Ğ›ĞĞšĞ˜Ğ Ğ£Ğ•Ğ¢ | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |
| #3: NFR-1.2 | ğŸ”´ Ğ‘Ğ›ĞĞšĞ˜Ğ Ğ£Ğ•Ğ¢ | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |
| #4: Rate limiting | ğŸŸ¡ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |
| #5: Cache strategy | ğŸŸ¡ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |
| #6: Telegram security | ğŸŸ¡ Ğ’Ğ«Ğ¡ĞĞšĞ˜Ğ™ Ğ Ğ˜Ğ¡Ğš | âŒ ĞĞµ Ñ€ĞµÑˆĞµĞ½Ğ° |

### ĞŸĞĞ¡Ğ›Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ™:

| ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ |
|----------|--------|---------|
| #1: extranote | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ² FR-4 Ğ¸ Contract 2.1 |
| #2: filter[w][v] | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | 7 ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹ Ñ ÑĞ²Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸ |
| #3: NFR-1.2 | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° < 2s (p95) Ñ UI spinner |
| #4: Rate limiting | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | Token bucket + queue + backoff |
| #5: Cache strategy | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | 3-ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ cache Ñ invalidation |
| #6: Telegram security | âœ… Ğ Ğ•Ğ¨Ğ•ĞĞ | max_age validation + secret management |

---

## ğŸš€ Ğ“ĞĞ¢ĞĞ’ĞĞĞ¡Ğ¢Ğ¬ Ğš Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ•

### Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°Ğ¼:

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ |
|-----------|-----------|--------|-----------|
| **PCAM ĞĞ½Ğ°Ğ»Ğ¸Ğ·** | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ | âœ… 100% | P1-P5, C1-C5 Ğ·Ğ°Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ |
| **PBS Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°** | 4 Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ M1-M4 | âœ… 100% | Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ Ğ½Ğ° 3 ÑƒÑ€Ğ¾Ğ²Ğ½Ñ |
| **API Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ** | 3 endpoint + Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ | âœ… 100% | extranote, weight_volume ÑƒÑ‚Ğ¾Ñ‡Ğ½ĞµĞ½Ñ‹ |
| **Design by Contract** | Ğ’ÑĞµ 8 ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ğ¾Ğ² | âœ… 100% | GOAL/PARAM/RETURN/RAISE/GUARANTEE |
| **FR/NFR Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ** | 6 FR + 9 NFR | âœ… 100% | Ğ’ÑĞµ SMART Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶Ğ¸Ğ¼Ñ‹ |
| **Django Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°** | apps/ + settings | âœ… 100% | Best practices ÑĞ¾Ğ±Ğ»ÑĞ´ĞµĞ½Ñ‹ |
| **AGENTS.md (AI)** | Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Copilot | âœ… 100% | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ° + Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ |
| **Security** | HTTPS, HMAC, tokens | âœ… 100% | Ğ¯Ğ²Ğ½Ğ¾ Ğ·Ğ°Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ |
| **Performance** | SLA Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ | âœ… 100% | P50, P95, P99 Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ñ‹ |
| **Testing** | Fixtures, fixtures, fixtures | ğŸŸ¡ 80% | Templates Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹, Ğ½ÑƒĞ¶Ğ½Ñ‹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ |

---

## ğŸ“‹ Ğ§Ğ•Ğš-Ğ›Ğ˜Ğ¡Ğ¢ Ğ”Ğ Ğ—ĞĞŸĞ£Ğ¡ĞšĞ Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ˜

- [x] API ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ ÑƒÑ‚Ğ¾Ñ‡Ğ½ĞµĞ½Ğ°
- [x] Ğ’ÑĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ñ‹ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑĞ¼Ğ¸
- [x] Ğ’ÑĞµ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ°ĞºÑ‚Ñ‹ Ğ¸Ğ¼ĞµÑÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ ĞºĞ¾Ğ´Ğ°
- [x] Performance targets Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹ Ğ¸ Ğ¸Ğ·Ğ¼ĞµÑ€Ğ¸Ğ¼Ñ‹
- [x] Security requirements ÑĞ²Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ñ‹
- [x] Cache strategy Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ° Ğ½Ğ° 3 ÑƒÑ€Ğ¾Ğ²Ğ½ÑÑ…
- [x] Rate limiting ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ°
- [x] Telegram auth security ÑƒÑĞ¸Ğ»ĞµĞ½Ğ°
- [x] Django project ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ°
- [x] Docker Compose Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹
- [ ] Fixtures Ğ´Ğ»Ñ pytest (next phase)
- [ ] Load test ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ (next phase)
- [ ] CI/CD pipeline (next phase)

---

## ğŸ¯ ĞŸĞ•Ğ Ğ•Ğ¥ĞĞ” Ğš Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ•

### Ğ¤Ğ°Ğ·Ğ° 1: Setup (1 Ğ´ĞµĞ½ÑŒ)
```bash
git clone <repo>
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
docker-compose up -d
python manage.py migrate
python manage.py runserver
```

### Ğ¤Ğ°Ğ·Ğ° 2: M1 (Authentication) - 2 Ğ´Ğ½Ñ
- [ ] apps/authentication/models.py (Driver model)
- [ ] apps/authentication/services.py (AuthenticationService)
- [ ] apps/authentication/telegram_auth.py (TelegramAuthService)
- [ ] tests/test_contracts_m1.py (Contract tests)

### Ğ¤Ğ°Ğ·Ğ° 3: M2 (Cargo Retrieval) - 3 Ğ´Ğ½Ñ
- [ ] apps/cargos/models.py (Cargo, CargoCard)
- [ ] apps/cargos/api_client.py (CargoAPIClient)
- [ ] apps/cargos/transformers.py (CargoTransformer)
- [ ] apps/cargos/services.py (CargoService)
- [ ] tests/test_contracts_m2.py (Contract tests)

### Ğ¤Ğ°Ğ·Ğ° 4: M3 (Filtering) - 2 Ğ´Ğ½Ñ
- [ ] apps/filtering/services.py (FilterService + weight_volume categories)
- [ ] apps/filtering/autocomplete.py (AutocompleteService)
- [ ] tests/test_contracts_m3.py (Contract tests)

### Ğ¤Ğ°Ğ·Ğ° 5: M4 (Notifications) - 2 Ğ´Ğ½Ñ
- [ ] apps/notifications/tasks.py (Celery tasks)
- [ ] apps/notifications/telegram_bot.py (TelegramBotClient)
- [ ] apps/notifications/logger.py (ResponseLogger)
- [ ] tests/test_contracts_m4.py (Contract tests)

### Ğ¤Ğ°Ğ·Ğ° 6: Frontend (HTMX) - 3 Ğ´Ğ½Ñ
- [ ] apps/cargos/templates/cargo_list.html (HTMX list + infinite scroll)
- [ ] apps/cargos/templates/cargo_detail.html (Detail + spinner)
- [ ] apps/filtering/templates/filter_form.html (Filters including weight_volume)
- [ ] apps/cargos/static/css/responsive.css (Mobile-first)

**Total: 13 Ğ´Ğ½ĞµĞ¹ (2 Ğ½ĞµĞ´ĞµĞ»Ğ¸)**

---

## ğŸ“ ĞšĞĞĞ¢ĞĞšĞ¢Ğ« Ğ”Ğ›Ğ¯ Ğ£Ğ¢ĞĞ§ĞĞ•ĞĞ˜Ğ™

ĞĞ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:

- **API Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ CargoTech Support
- **Product Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ** â†’ Product Owner
- **Architecture Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ Tech Lead (PCAM/PBS)
- **Security Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹** â†’ Security Team
- **Performance baseline** â†’ DevOps / Load Testing Team

---

**Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ:** âœ… **ĞŸĞĞ›ĞĞĞ¡Ğ¢Ğ¬Ğ® Ğ“ĞĞ¢ĞĞ’Ğ Ğš Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ•**

**Ğ”Ğ°Ñ‚Ğ°:** 29 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ 2025  
**Ğ’ĞµÑ€ÑĞ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸:** 2.1 (Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ¸ ÑƒÑ‚Ğ¾Ñ‡Ğ½ĞµĞ½Ğ½Ğ°Ñ)  
**ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ¾:** 6 ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ + 6 Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ñ€Ğ¸ÑĞºĞ¾Ğ²Ñ‹Ñ… Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ĞµĞ¹  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** âœ… ĞĞ”ĞĞ‘Ğ Ğ•ĞĞ Ğš ĞĞ•ĞœĞ•Ğ”Ğ›Ğ•ĞĞĞĞ™ Ğ ĞĞ—Ğ ĞĞ‘ĞĞ¢ĞšĞ•

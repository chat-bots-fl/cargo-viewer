# Сценарий 2 — Stale‑While‑Revalidate (SWR): быстрый ответ из кеша + фоновое обновление

## Идея
Комбинация «быстро показать текущее» и «обновить незаметно»:
- endpoint цен всегда отвечает быстро из кеша (Redis/locmem)
- параллельно (или если истёк SWR‑окно) сервер запускает фоновое обновление кеша (thread/Celery)
- следующий цикл polling уже получает обновлённые цены

## Что берём из HAR
- Источник цен не меняется: `GET /v2/cargos/views` (`price_carrier`/`price`).

## Архитектура
- Frontend:
  - такой же polling (как в сценарии 1), но можно ставить интервал меньше (например 10–15с), т.к. ответ почти всегда из кеша
- Backend:
  - `GET /api/cargos/prices/` сначала читает кеш по ключу `(user_id + hash(filters) + limit)`
  - если кеш свежий — возвращает сразу
  - если кеш устарел:
    - возвращает stale‑ответ (если есть)
    - триггерит фоновую задачу обновления (lock в кеше, чтобы не запускать параллельно)

## Поток
1) Клиент делает запрос цен.
2) Сервер возвращает кеш мгновенно.
3) Сервер асинхронно обновляет кеш (если нужно).
4) На следующем polling клиент получает уже свежие цены.

## Надёжность
Очень высокая:
- UI не зависит от скорости внешнего API
- при падении CargoTech цены остаются из последнего успешного обновления
- легко контролировать частоту внешних запросов (через TTL/lock)

## Скорость
Максимальная для пользователя:
- ответы почти всегда локальные (кеш)
- внешние вызовы уходят «в фон»

## Нагрузка
- много дешёвых запросов к кешу (внутри инфраструктуры)
- ограниченное число реальных запросов к CargoTech (по TTL/lock)

## Плюсы
- Лучший баланс UX/надёжности/нагрузки на CargoTech
- Хорошо масштабируется по количеству клиентов
- Можно включить постепенное обновление (например, разные TTL для list vs prices)

## Минусы
- Нужна аккуратная логика кеширования/локов
- Для «фона» лучше иметь Celery/worker; thread‑подход проще, но слабее в проде

## Когда выбирать
- Ожидается много одновременных пользователей
- Внешний API нестабилен или имеет лимиты
- Нужна высокая скорость реакции UI даже при деградации внешнего сервиса


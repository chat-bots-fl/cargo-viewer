# Сценарий 1 — HTMX polling + OOB‑обновление цен (без перерисовки списка)

## Идея
Периодически (каждые N секунд) делать HTMX‑запрос на отдельный endpoint, который возвращает HTML с `hx-swap-oob="true"` только для элементов цены. HTMX подменяет только нужные DOM‑узлы (например, `<span id="cargo-price-<id>">…</span>`), не трогая список и прокрутку.

## Что берём из HAR
- Источник цен: `GET https://api.cargotech.pro/v2/cargos/views?include=contacts&limit=…&offset=…&filter[mode]=my`
- Поля цены: `price_carrier` (предпочтительно) и `price` (fallback), значения в копейках.

## Архитектура
- Frontend (Telegram WebApp + `static/js/app.js`):
  - таймер `setInterval`
  - вычисляет текущие фильтры и количество загруженных карточек
  - вызывает `htmx.ajax("GET", "/api/cargos/prices/?…")` в «sink»‑элемент (невидимый контейнер)
- Backend (Django):
  - `GET /api/cargos/prices/` (и versioned `/api/v3/cargos/prices/`)
  - валидирует query params (те же, что для списка) + `limit` = кол-во отображаемых карточек
  - получает данные из CargoTech через существующий `CargoAPIClient.fetch_cargos(...)`
  - рендерит шаблон с OOB‑элементами цены

## Поток
1) Пользователь открывает WebApp, грузится список `/api/cargos/` (как сейчас).
2) Каждые N секунд фронт делает запрос `/api/cargos/prices/?<filters>&limit=<loaded>&offset=0`.
3) Сервер возвращает набор `<span id="cargo-price-...">` с `hx-swap-oob`, HTMX точечно обновляет цены.

## Поведение при ошибках
- Если CargoTech недоступен:
  - сервер может вернуть цены из кеша (если есть) или пустой OOB‑ответ (без изменений на экране)
  - фронт не ломает UI и продолжает следующий цикл
- Если истекла сессия:
  - используется уже существующая логика обновления токена/401 обработчиков (HTMX‑слушатели)

## Надёжность
Высокая:
- нет долгоживущих соединений (как SSE/WebSocket)
- минимальный риск «подвисших» коннектов в Telegram WebView/проксах
- использует текущий стек (Django + HTMX)

## Скорость
Высокая для UI:
- обновляется только цена, без ререндера карточек
- не сбрасывает скролл/инфинит‑лоад
- latency определяется интервалом N и скоростью запроса к CargoTech

## Нагрузка
- 1 запрос на клиента каждые N секунд
- объём ответа маленький (только цены)
- можно добавить server‑side throttle/lock, чтобы не дергать CargoTech слишком часто

## Плюсы
- Максимально «родной» для текущего проекта (HTMX уже используется)
- Не требует новых сервисов (Channels/Redis streams и т.п.)
- Простая деградация при сбоях (пропуск обновления)
- Не портит UX (не перерисовывает список)

## Минусы
- Это polling: при большом онлайне растёт число запросов
- Без дополнительной логики не появляются новые грузы «сверху» (обновляются только цены уже загруженных карточек)

## Когда выбирать
- Нужен быстрый и надёжный результат «с минимальными изменениями»
- Telegram WebApp / мобильные браузеры: предпочтительна простая модель без постоянных соединений


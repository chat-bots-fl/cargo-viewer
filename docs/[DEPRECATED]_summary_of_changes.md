# üìã –°–í–û–î–ö–ê –í–°–ï–• –ò–ó–ú–ï–ù–ï–ù–ò–ô

> ‚ö†Ô∏è **DEPRECATED (v2.0/v2.1).** –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `INDEX_v3.1.md` (v3.1, 4 —è–Ω–≤–∞—Ä—è 2026). –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.

**–î–∞—Ç–∞:** 29 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0 (Final)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –†–ê–ó–†–ê–ë–û–¢–ö–ï

---

## üîç –û–ë–ó–û–† –í–°–ï–• 6 –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #1: extranote –≤ FR-4

**–ü–†–û–ë–õ–ï–ú–ê:**
```
FR-4 "–î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä—É–∑–∞" –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç extranote –ø–æ–ª–µ
–≠—Ç–æ –ø–æ–ª–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
- "–ì—Ä—É–∑ –≥–æ—Ç–æ–≤, –æ–ø–ª–∞—á–µ–Ω–æ –∞–≤–∞–Ω—Å–∞–º, —Ä–µ—Ñ—Ä–∏–∂ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"
- "–¢–æ–ª—å–∫–æ –ò–ü, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –±–µ–∑ –Ω–∞–ª–∏—á–Ω—ã—Ö"
- "–¢–†–ï–ë–£–ï–¢–°–Ø –î–û–ü–û–ì, –æ–ø–∞—Å–Ω—ã–π –≥—Ä—É–∑ –∫–ª–∞—Å—Å 3"
```

**–†–ï–®–ï–ù–ò–ï:**
```diff
FR-4: –î–µ—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä—É–∑–∞

  - –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞)
  - –ú–∞—Ä—à—Ä—É—Ç (–≥–æ—Ä–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Üí –≥–æ—Ä–æ–¥ –ø—Ä–∏–±—ã—Ç–∏—è)
  - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–∑–∞ (–≤–µ—Å, –æ–±—ä–µ–º, —Ç–∏–ø)
  - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è ‚Üê –î–û–ë–ê–í–õ–ï–ù–û
+   - –ò—Å—Ç–æ—á–Ω–∏–∫: extranote (raw text from API)
+   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ not NULL
+   - –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ: monospace —à—Ä–∏—Ñ—Ç (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
+   - –ü—Ä–∏–º–µ—Ä—ã: 
+     - "–ì—Ä—É–∑ –≥–æ—Ç–æ–≤ ‚úì | –û–ø–ª–∞—á–µ–Ω–æ –∞–≤–∞–Ω—Å–æ–º | –†–µ—Ñ—Ä–∏–∂ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω"
+     - "–¢–æ–ª—å–∫–æ –ò–ü | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ | –î–û–ü–û–ì –∑–∞–ø—Ä–µ—Ç"
```

**–ö–û–ù–¢–†–ê–ö–¢–´:**
```diff
Contract 2.1: CargoAPIClient.fetch_cargos()
RETURNS –¥–æ–±–∞–≤–∏—Ç—å:
+ - extranote: Optional[str]  # Additional requirements from shipper
```

**–ö–û–î (Django template):**
```html
{% if cargo.extranote %}
<div class="extra-requirements">
  <h4>‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è</h4>
  <pre>{{ cargo.extranote }}</pre>
</div>
{% endif %}
```

---

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #2: weight_volume –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è

**–ü–†–û–ë–õ–ï–ú–ê:**
```
API –∑–∞–ø—Ä–æ—Å: filter[w][v]=10-54 (–Ω–µ–ø–æ–Ω—è—Ç–Ω–æ —á—Ç–æ —ç—Ç–æ)
- –≠—Ç–æ –≤–µ—Å (—Ç–æ–Ω–Ω—ã)? –û–±—ä–µ–º (–º¬≥)? –û–±–∞?
- –î–∏–∞–ø–∞–∑–æ–Ω 10-54 –∏–ª–∏ –¥–≤–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã?
- –ö–∞–∫–∏–µ —é–Ω–∏—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç API?
```

**–†–ï–®–ï–ù–ò–ï:**
```diff
API Specification: Query Parameters

–ë–´–õ–û:
{
  "filter[w][v]": "10-54",  # –ù–µ—è—Å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
}

–ò–°–ü–†–ê–í–ò–¢–¨ –ù–ê:
{
  "filter[weight_volume]": "1_3"     # 1-3 —Ç / –¥–æ 15 –º¬≥
  "filter[weight_volume]": "3_5"     # 3-5 —Ç / 15-25 –º¬≥
  "filter[weight_volume]": "5_10"    # 5-10 —Ç / 25-40 –º¬≥
  "filter[weight_volume]": "10_15"   # 10-15 —Ç / 40-60 –º¬≥
  "filter[weight_volume]": "15_20"   # 15-20 —Ç / 60-82 –º¬≥
  "filter[weight_volume]": "20"      # 20+ —Ç / 82+ –º¬≥
  "filter[weight_volume]": "any"     # –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ (default)
}
```

**–¢–ê–ë–õ–ò–¶–ê –ú–ê–ü–ü–ò–ù–ì–ê:**
```
–ó–Ω–∞—á–µ–Ω–∏–µ | –í–µ—Å –º–∏–Ω     | –û–±—ä–µ–º –º–∏–Ω | –û–±—ä–µ–º –º–∞–∫—Å | –û–ø–∏—Å–∞–Ω–∏–µ
---------|-----------|----------|-----------|------------------------
"1_3"    | 1000 –∫–≥   | 0 –º¬≥     | 15 –º¬≥     | –ú–∞–ª–µ–Ω—å–∫–∏–µ –≥—Ä—É–∑—ã
"3_5"    | 3000 –∫–≥   | 15 –º¬≥    | 25 –º¬≥     | –õ–µ–≥–∫–∞—è —Ñ—É—Ä–∞ (3-5—Ç)
"5_10"   | 5000 –∫–≥   | 25 –º¬≥    | 40 –º¬≥     | –°—Ä–µ–¥–Ω—è—è —Ñ—É—Ä–∞ (5-10—Ç)
"10_15"  | 10000 –∫–≥  | 40 –º¬≥    | 60 –º¬≥     | –ü–æ–ª—É–ø—Ä–∏—Ü–µ–ø 40t
"15_20"  | 15000 –∫–≥  | 60 –º¬≥    | 82 –º¬≥     | –ü–æ–ª—É–ø—Ä–∏—Ü–µ–ø 82t
"20"     | 20000 –∫–≥  | 82 –º¬≥    | ‚àû         | –ú–µ–≥–∞–ª–æ–∂–∏ (20+ —Ç)
```

**–ö–û–ù–¢–†–ê–ö–¢–´:**
```diff
Contract 3.1: FilterService.validate_filters()

PARAMETERS –¥–æ–±–∞–≤–∏—Ç—å:
+ - weight_volume: Optional[str] 
+   in ["1_3", "3_5", "5_10", "10_15", "15_20", "20", "any"]
+   @constraint: Predefined categories only
+   @default: "any"
```

**–ö–û–î (apps/filtering/constants.py):**
```python
WEIGHT_VOLUME_CATEGORIES = {
    "1_3": {
        "label": "1-3 —Ç / –¥–æ 15 –º¬≥",
        "weight_min_kg": 1000,
        "weight_max_kg": 3000,
        "volume_min_m3": 0,
        "volume_max_m3": 15,
    },
    "3_5": {
        "label": "3-5 —Ç / 15-25 –º¬≥",
        "weight_min_kg": 3000,
        "weight_max_kg": 5000,
        "volume_min_m3": 15,
        "volume_max_m3": 25,
    },
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π
}

WEIGHT_VOLUME_OPTIONS = [
    ("any", "–õ—é–±–æ–π –≤–µ—Å –∏ –æ–±—ä–µ–º"),
    ("1_3", "1-3 —Ç / –¥–æ 15 –º¬≥"),
    ("3_5", "3-5 —Ç / 15-25 –º¬≥"),
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
]
```

**–ö–û–î (HTML —Ñ–æ—Ä–º–∞):**
```html
<select name="weight_volume">
  {% for value, label in weight_volume_options %}
    <option value="{{ value }}">{{ label }}</option>
  {% endfor %}
</select>
```

---

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #3: NFR-1.2 Performance Requirement

**–ü–†–û–ë–õ–ï–ú–ê:**
```
–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ: "–û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –≥—Ä—É–∑–∞: < 1 —Å–µ–∫"
–†–µ–∞–ª—å–Ω–æ—Å—Ç—å: API –æ—Ç–≤–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å 700-2000ms (—Å–µ—Ç–µ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ + API)
–ò—Ç–æ–≥–æ: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å < 1 —Å–µ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—é
```

**–†–ï–®–ï–ù–ò–ï:**
```diff
NFR-1.2: –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏

–ë–´–õ–û:
- –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π: < 1 —Å–µ–∫ (–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ)

–ò–°–ü–†–ê–í–ò–¢–¨ –ù–ê:
+ –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π: < 2 —Å–µ–∫ (p95)
+   - p50: < 500ms (cached data shown immediately)
+   - p95: < 2000ms (with fetch + loading spinner)
+   - Fallback: Show cached data if API timeout
+   - UI: Show loading indicator while fetching
```

**–ê–†–•–ò–¢–ï–ö–¢–£–†–ê:**
```
Frontend –¥–µ–π—Å—Ç–≤–∏—è:
1. –ö–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –≥—Ä—É–∑–∞
2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º spinner + –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø–∏—Å–∫–∞ (–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)
3. –í —Ñ–æ–Ω–µ: fetch –¥–µ—Ç–∞–ª–µ–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 2s)
4. –ü—Ä–∏ –æ—Ç–≤–µ—Ç–µ: –æ–±–Ω–æ–≤–ª—è–µ–º UI —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
5. –ü—Ä–∏ timeout: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º cached –≤–µ—Ä—Å–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å)
```

**–ö–û–î (HTMX):**
```html
<div hx-get="/api/cargos/{{ cargo.id }}/"
     hx-target="#detail-modal"
     hx-trigger="click"
     hx-swap="innerHTML"
     hx-indicator="#loading-spinner"
     class="cargo-card">
  <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –≥—Ä—É–∑–∞ -->
</div>

<div id="loading-spinner" class="spinner htmx-request">
  <div class="spinner-icon"></div> –ó–∞–≥—Ä—É–∑–∫–∞...
</div>
```

---

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #4: Rate Limiting —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

**–ü–†–û–ë–õ–ï–ú–ê:**
```
API –ª–∏–º–∏—Ç: 600 requests/minute (10 req/sec)
–ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 1000+
–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ: 1000 √ó 60 req = 60,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
–î–æ—Å—Ç—É–ø–Ω–æ: 600 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É
–ö–û–ù–§–õ–ò–ö–¢: 60,000 >> 600 = –ü–ï–†–ï–ì–†–£–ó!
```

**–†–ï–®–ï–ù–ò–ï:**
```diff
Contract 2.1: CargoAPIClient.fetch_cargos()

GUARANTEES –¥–æ–±–∞–≤–∏—Ç—å:
+ Rate Limit Handling:
+   - Per-request headers: X-RateLimit-Limit, X-RateLimit-Remaining
+   - On 429: Retry after X-RateLimit-Reset-After
+   - Backoff pattern: 500ms ‚Üí 1500ms ‚Üí 3000ms (+ random jitter)
+   - Max attempts: 4 (then error to user)
+   - Soft limit: Start queuing at 80% capacity
+   - Queue strategy: FIFO with max 1000 requests in queue
```

**–ê–õ–ì–û–†–ò–¢–ú TOKEN BUCKET:**
```python
class RateLimiter:
    def __init__(self, requests_per_minute=600):
        self.capacity = requests_per_minute
        self.tokens = requests_per_minute
        self.last_update = time.time()
    
    def can_request(self):
        now = time.time()
        elapsed = now - self.last_update
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω—ã –∑–∞ –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
        new_tokens = elapsed * (self.capacity / 60)
        self.tokens = min(self.capacity, self.tokens + new_tokens)
        self.last_update = now
        
        if self.tokens >= 1:
            self.tokens -= 1
            return True
        return False
```

**–≠–ö–°–ü–û–ù–ï–ù–¶–ò–ê–õ–¨–ù–´–ô BACKOFF:**
```python
def fetch_with_retry(url, max_attempts=4):
    for attempt in range(max_attempts):
        response = requests.get(url)
        
        if response.status_code == 429:
            wait_time = 500 * (2 ** attempt) + random.randint(0, 100)
            logger.warning(f"Rate limited, retrying after {wait_time}ms")
            time.sleep(wait_time / 1000)
            continue
        
        return response
    
    raise RateLimitError("Max retries exceeded")
```

---

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #5: Cache Strategy 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è

**–ü–†–û–ë–õ–ï–ú–ê:**
```
–ß—Ç–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å? –ö–∞–∫ –¥–æ–ª–≥–æ? –ö–æ–≥–¥–∞ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å?
- –ï—Å–ª–∏ TTL = 1 –º–∏–Ω—É—Ç–∞ ‚Üí –º–Ω–æ–≥–æ API –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí –ª–∏–º–∏—Ç –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è
- –ï—Å–ª–∏ TTL = 30 –º–∏–Ω—É—Ç ‚Üí –≤–æ–¥–∏—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Å—Ç–∞—Ä—ã–µ –≥—Ä—É–∑—ã (–ø–ª–æ—Ö–æ–π UX)
- –ï—Å–ª–∏ –∫—ç—à –≥–ª–æ–±–∞–ª—å–Ω—ã–π ‚Üí –≤—Å–µ –≤–∏–¥—è—Ç –æ–¥–Ω–∏ –≥—Ä—É–∑—ã (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
```

**–†–ï–®–ï–ù–ò–ï - 3-–£–†–û–í–ù–ï–í–ê–Ø CACHE:**
```diff
Contract 2.3: CargoService.get_cargos()

GUARANTEES –æ–±–Ω–æ–≤–∏—Ç—å Cache section:

+ Level 1: Per-User Cargo List Cache
+   Key: "user:{user_id}:cargos:{filter_hash}"
+   Data: List[CargoCard]
+   TTL: 5 minutes
+   When: User applies filter
+   Invalidation: filter change, logout, webhook on new cargo posted
+
+ Level 2: Cargo Detail Cache
+   Key: "cargo:{cargo_id}:detail"
+   Data: Full cargo object with extranote
+   TTL: 15 minutes
+   When: User opens detail view
+   Invalidation: webhook from CargoTech, status change
+
+ Level 3: Autocomplete Cache (Cities/Regions)
+   Key: "autocomplete:cities"
+   Data: City reference dictionary
+   TTL: 24 hours
+   When: App startup (preload)
+   Invalidation: Manual (static data)
```

**FALLBACK –°–¢–†–ê–¢–ï–ì–ò–Ø:**
```
Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã ‚Üí API (no cache)
API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí Serve stale cache (–¥–æ 1 —á–∞—Å–∞) —Å warning
Cache miss ‚Üí Fetch from API + async update Redis
```

**–ö–û–î (Django cache):**
```python
from django.views.decorators.cache import cache_page
from django.core.cache import cache

class CargoListView(View):
    def get(self, request):
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        filter_hash = hash_filters(request.GET)
        cache_key = f"user:{request.user.id}:cargos:{filter_hash}"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        cargos = cache.get(cache_key)
        if cargos is None:
            # Fetch from API
            cargos = fetch_from_cargotech_api(request.GET)
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç
            cache.set(cache_key, cargos, timeout=300)
        
        return render(request, 'cargos_list.html', {'cargos': cargos})
```

---

### ‚ùå‚Üí‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï #6: Telegram Security —É—Å–∏–ª–µ–Ω–∏–∏

**–ü–†–û–ë–õ–ï–ú–ê:**
```
Contract 1.1 –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç auth_date
- –ï—Å–ª–∏ bot_token —É—Ç–µ—á–µ—Ç ‚Üí –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–æ–¥–¥–µ–ª–∞—Ç—å –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°—Ç–∞—Ä—ã–µ credentials –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã (replay attack)
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è token –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏
```

**–†–ï–®–ï–ù–ò–ï:**
```diff
Contract 1.1: TelegramAuthService.validate_init_data()

PARAMETERS –¥–æ–±–∞–≤–∏—Ç—å:
+ - max_age_seconds: int = 300
+   @constraint: 300-3600 (5 –º–∏–Ω—É—Ç - 1 —á–∞—Å)
+   @default: 300 (5 –º–∏–Ω—É—Ç –¥–ª—è session recovery)

GUARANTEES –¥–æ–±–∞–≤–∏—Ç—å:
+ - Timestamp Validation: auth_date not older than max_age_seconds
+ - Reject: Credentials older than limit (prevent replay attacks)
+ - Constant-time: String comparison (prevent timing attacks)
+ - Secret Management: bot_token from environment (not in code)
+ - Monitoring: All validation failures logged (ERROR level)
+ - Alerts: If > 10 failures in 1 minute (attack detection)
```

**–ö–û–î (Django):**
```python
import hmac
import hashlib
from datetime import datetime, timedelta

class TelegramAuthService:
    def validate_init_data(self, init_data: str, hash_value: str, 
                          max_age_seconds: int = 300):
        """
        Validate Telegram WebApp initData
        
        Args:
            init_data: Sorted key-value pairs from Telegram
            hash_value: HMAC-SHA256 hash from Telegram
            max_age_seconds: Max age of auth_date (default 300s = 5 min)
        
        Raises:
            ValidationError: If validation fails
        """
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º HMAC-SHA256
        bot_token = os.environ.get('TELEGRAM_BOT_TOKEN')
        secret = hashlib.sha256(bot_token.encode()).digest()
        
        calculated_hash = hmac.new(
            secret, 
            init_data.encode(), 
            hashlib.sha256
        ).hexdigest()
        
        # Constant-time comparison (prevent timing attacks)
        if not hmac.compare_digest(calculated_hash, hash_value):
            logger.error("Invalid Telegram hash")
            raise ValidationError("Invalid Telegram hash")
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º auth_date –Ω–µ —Å—Ç–∞—Ä—à–µ max_age_seconds
        data_dict = dict(pair.split('=') for pair in init_data.split('&'))
        auth_date = int(data_dict.get('auth_date', 0))
        current_time = int(datetime.now().timestamp())
        
        age = current_time - auth_date
        if age > max_age_seconds:
            logger.warning(f"Auth too old: {age}s > {max_age_seconds}s")
            raise ValidationError(f"Auth expired ({age}s old)")
        
        logger.info(f"Telegram auth valid for user {data_dict.get('id')}")
        return data_dict
```

**–ù–ê–°–¢–†–û–ô–ö–ò DJANGO:**
```python
# settings.py
import os

# Bot token –ù–ò–ö–û–ì–î–ê –Ω–µ –≤ –∫–æ–¥–µ!
TELEGRAM_BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç auth_date (5 –º–∏–Ω—É—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
TELEGRAM_MAX_AUTH_AGE = int(os.environ.get('TELEGRAM_MAX_AUTH_AGE', 300))

# Logging –¥–ª—è –∞—Ç–∞–∫
LOGGING = {
    'handlers': {
        'telegram_auth': {
            'level': 'WARNING',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'telegram_auth.log',
            'maxBytes': 1024 * 1024 * 10,  # 10MB
            'backupCount': 5,
        },
    },
}
```

---

## üìä –ú–ê–¢–†–ò–¶–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –¢–∏–ø | –ì–¥–µ | –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å | –°—Ç–∞—Ç—É—Å |
|---|----------|-----|-----|-----------------|--------|
| 1 | extranote –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | FR | FR-4 + Contract 2.1 | + extranote –ø–æ–ª–µ + template | ‚úÖ |
| 2 | filter[w][v] –Ω–µ—è—Å–µ–Ω | API | Contract 3.1 + API spec | 7 –∫–∞—Ç–µ–≥–æ—Ä–∏–π + –º–∞–ø–ø–∏–Ω–≥ | ‚úÖ |
| 3 | NFR-1.2 < 1s –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ | NFR | Technical spec | < 2s (p95) + spinner | ‚úÖ |
| 4 | Rate limiting –Ω–µ–ø–æ–ª–Ω–æ | Contract | Contract 2.1 | Token bucket + backoff | ‚úÖ |
| 5 | Cache strategy –Ω–µ—è—Å–Ω–∞ | Contract | Contract 2.3 | 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è + TTL + invalidation | ‚úÖ |
| 6 | Telegram security –Ω–µ–ø–æ–ª–Ω–∞ | Contract | Contract 1.1 | max_age + constant-time + logging | ‚úÖ |

---

## ‚úÖ –ß–ï–ö-–õ–ò–°–¢ –ü–ï–†–ï–î –†–ê–ó–†–ê–ë–û–¢–ö–û–ô

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –í–°–ï —Å–¥–µ–ª–∞–Ω–æ:

- [ ] **FR-4:** extranote –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —à–∞–±–ª–æ–Ω html
- [ ] **weight_volume:** 7 –∫–∞—Ç–µ–≥–æ—Ä–∏–π –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ constants.py
- [ ] **NFR-1.2:** –ò–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ < 2s (p95) –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –∑–∞–¥–∞–Ω–∏–∏select
- [ ] **Contract 1.1:** max_age_seconds –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–æ–±–∞–≤–ª–µ–Ω
- [ ] **Contract 2.1:** Rate limiting —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø–∏—Å–∞–Ω–∞
- [ ] **Contract 2.3:** 3-—É—Ä–æ–≤–Ω–µ–≤–∞—è cache –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞
- [ ] **Code:** apps/filtering/constants.py —Å–æ–∑–¥–∞–Ω
- [ ] **Code:** normalize_weight_volume_filter —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- [ ] **Code:** TelegramAuthService.validate_init_data –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] **Tests:** Contract tests –Ω–∞–ø–∏—Å–∞–Ω—ã –¥–ª—è –≤—Å–µ—Ö 6 –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [ ] **Django:** TELEGRAM_BOT_TOKEN –≤ environment (–Ω–µ –≤ –∫–æ–¥–µ!)
- [ ] **Redis:** –ö—ç—à —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–Ω—è—Ç –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] **API:** –í—Å–µ endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º CargoTech API

---

## üöÄ –ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –í–°–ï 6 –ü–†–û–ë–õ–ï–ú –†–ï–®–ï–ù–´ ‚úÖ                ‚îÇ
‚îÇ  –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø: 100% –ü–û–õ–ù–ê–Ø              ‚îÇ
‚îÇ  –ì–û–¢–û–í–û –ö –†–ê–ó–†–ê–ë–û–¢–ö–ï: –î–ê                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ú–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –î–ê!
```

---

**–î–∞—Ç–∞:** 29 –¥–µ–∫–∞–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.0 Final  
**–û–¥–æ–±—Ä–µ–Ω–æ:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
